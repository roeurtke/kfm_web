{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">LIST USER</h6>
        <a href="{% url 'create_user' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus"></i> Create
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Limit Balance</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loop through the incomes and display them in the table -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    // ========== CONFIGURATION (Runs first - Sets up constants) ==========
    const apiBaseUrl = 'http://127.0.0.1:8000/api';
    const maxTokenRefreshAttempts = 1;

    // ========== CORE FUNCTIONS (Define before they're called) ==========
    
    // 1. Token Refresh Function
    async function refreshToken() {
        try {
            const response = await fetch(`${apiBaseUrl}/token/refresh/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh: localStorage.getItem('refreshToken') })
            });

            if (!response.ok) throw new Error('Token refresh failed');
            
            const data = await response.json();
            localStorage.setItem('accessToken', data.access);
            return data.access;

        } catch (error) {
            console.error('Token refresh error:', error);
            window.location.href = '/login/';
            return null;
        }
    }

    // 2. Data Fetching Function
    async function fetchUsers(retryCount = 0) {
        let accessToken = localStorage.getItem('accessToken');
        
        try {
            const response = await fetch(`${apiBaseUrl}/users/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            if (response.status === 401 && retryCount < maxTokenRefreshAttempts) {
                const newToken = await refreshToken();
                if (newToken) {
                    return fetchUsers(retryCount + 1);
                }
                return null;
            }

            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }

            return await response.json();

        } catch (error) {
            console.error('Fetch error:', error);
            return null;
        }
    }

    // 3. Rendering Function
    function renderUserTable(users) {
        const tableBody = document.querySelector("#dataTable tbody");
        if (!tableBody) return;

        tableBody.innerHTML = '';
        users.sort((a, b) => b.id - a.id);
        
        let fakeId = 1;

        users.forEach(user => {
            const row = document.createElement("tr");

            const addCell = (value) => {
                const td = document.createElement("td");
                td.textContent = value || 'N/A';
                return td;
            };

            // Add cells
            row.appendChild(addCell(fakeId++));
            row.appendChild(addCell(user.username));
            row.appendChild(addCell(user.email));
            row.appendChild(addCell(user.first_name));
            row.appendChild(addCell(user.last_name));
            row.appendChild(addCell(user.spending_limit));
            row.appendChild(addCell(user.role?.name || user.role));
            row.appendChild(addCell(formatDate(user.created_at)));
            row.appendChild(addCell(formatDate(user.updated_at)));

            // Action buttons
            const actionCell = document.createElement("td");
            actionCell.appendChild(createActionLink(`/users/${user.id}/`, "View", "btn-info"));
            actionCell.appendChild(createActionLink(`/users/${user.id}/edit/`, "Edit", "btn-warning"));
            actionCell.appendChild(createActionLink(`/users/${user.id}/delete/`, "Delete", "btn-danger", true));
            
            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });

        initializeDataTable();
    }

    // ========== EXECUTION FLOW (Runs when DOM is ready) ==========
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            // 1. First - Fetch users
            const users = await fetchUsers();
            
            // 2. Then - Render results
            if (users && users.length > 0) {
                renderUserTable(users);
            } else {
                console.warn("No users found or failed to fetch.");
                renderUserTable([]);
            }
        } catch (error) {
            console.error("Initialization error:", error);
            renderUserTable([]);
        }
    });
</script>
{% endblock %}