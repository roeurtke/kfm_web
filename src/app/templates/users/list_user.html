{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Page Heading -->
<!-- <h1 class="h3 mb-2 text-gray-800">List User</h1> -->

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">LIST USER</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-dark">
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Limit Balance</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loop through the incomes and display them in the table -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const users = await fetchUsers();
            if (users && users.length > 0) {
                renderUserTable(users);
            } else {
                console.warn("No users found or failed to fetch.");
            }
        } catch (error) {
            console.error("Initialization error:", error);
        }
    });

    // ================== Core Functions ==================
    async function fetchUsers(retryAttempt = 0) {
        const MAX_RETRIES = 1; // Prevent infinite loops
        let accessToken = localStorage.getItem("accessToken");

        // No token at all? Force login
        if (!accessToken) {
            redirectToLogin("Please login first");
            return null;
        }

        try {
            const response = await fetch("http://127.0.0.1:8000/api/users/", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${accessToken}`
                }
            });

            // Silent token refresh on 401
            if (response.status === 401 && retryAttempt < MAX_RETRIES) {
                const newToken = await refreshAccessToken(true); // Silent mode
                if (newToken) {
                    return fetchUsers(retryAttempt + 1); // Retry with new token
                }
                // If refresh fails, continue to throw error
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            return data.users || data.results || data;
        } catch (error) {
            handleFetchError(error);
            return null;
        }
    }

    function renderUserTable(users) {
        const tableBody = document.querySelector("#dataTable tbody");
        if (!tableBody) return;

        // Clear existing rows (if any)
        tableBody.innerHTML = '';

        // Create rows for each user
        users.forEach(user => {
            const row = document.createElement("tr");

            // Helper to safely insert cell data
            const addCell = (value) => {
                const td = document.createElement("td");
                td.textContent = value || 'N/A';
                return td;
            };

            // Add cells in order of your table headers
            row.appendChild(addCell(user.username));
            row.appendChild(addCell(user.email));
            row.appendChild(addCell(user.first_name));
            row.appendChild(addCell(user.last_name));
            row.appendChild(addCell(user.spending_limit));
            row.appendChild(addCell(user.role?.name || user.role));
            
            // Format dates (optional)
            row.appendChild(addCell(formatDate(user.created_at)));
            row.appendChild(addCell(formatDate(user.updated_at)));

            // Action buttons
            const actionCell = document.createElement("td");
            actionCell.appendChild(createActionLink(`/users/${user.id}/`, "View", "btn-info"));
            actionCell.appendChild(createActionLink(`/users/${user.id}/edit/`, "Edit", "btn-warning"));
            actionCell.appendChild(createActionLink(`/users/${user.id}/delete/`, "Delete", "btn-danger", true));
            
            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });

        // Initialize DataTable (if using jQuery DataTables)
        initializeDataTable();
    }

    // ================== Helper Functions ==================
    function createActionLink(href, text, className, isDelete = false) {
        const link = document.createElement("a");
        link.href = href;
        link.textContent = text;
        link.className = `btn btn-sm ${className} mx-1`;

        if (isDelete) {
            link.onclick = (e) => {
                if (!confirm("Are you sure you want to delete this user?")) {
                    e.preventDefault();
                }
            };
        }
        return link;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    }

    async function refreshAccessToken(silent = false) {
        const refreshToken = localStorage.getItem("refreshToken");
        if (!refreshToken) {
            if (!silent) redirectToLogin("Session expired");
            return null;
        }

        try {
            const response = await fetch("http://127.0.0.1:8000/api/token/refresh/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ refresh: refreshToken })
            });

            // Refresh token itself expired? Force login
            if (response.status === 401) {
                if (!silent) redirectToLogin("Session expired");
                return null;
            }

            if (!response.ok) throw new Error(`Refresh failed (HTTP ${response.status})`);

            const { access } = await response.json();
            if (!access) throw new Error("No access token received");

            localStorage.setItem("accessToken", access);
            return access;

        } catch (error) {
            console.error("Refresh failed:", error);
            if (!silent) {
                clearAuthData();
                redirectToLogin("Session expired");
            }
            return null;
        }
    }

    function redirectToLogin(message) {
        if (message) {
            alert(message); // Or use a toast/notification library for better UX
        }
        // Clear any residual auth data
        clearAuthData();
        // Redirect to login (replace with your actual login path)
        window.location.href = "/login/";
    }
    function handleFetchError(error) {
        console.error("API Request Failed:", error);

        // Handle specific error cases
        if (error.message.includes("expired") || error.message.includes("401")) {
            redirectToLogin("Session expired - please login again");
        } 
        else if (error.message.includes("403")) {
            redirectToLogin("Permission denied");
        }
        else {
            // Generic error display (avoid showing raw errors to users)
            alert("Operation failed. Please try again or contact support.");
        }
    }
</script>
{% endblock %}