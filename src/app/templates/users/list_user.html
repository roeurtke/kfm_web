{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Page Heading -->
<!-- <h1 class="h3 mb-2 text-gray-800">List User</h1> -->

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">LIST USER</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-dark">
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Limit Balance</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- Loop through the incomes and display them in the table -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        async function fetchUsers() {
            let accessToken = localStorage.getItem("accessToken");
            if (!accessToken) {
                alert("Please login first");
                window.location.href = "/login/";
                return;
            }

            try {
                let response = await fetch("http://127.0.0.1:8000/api/users/", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    }
                });

                if (response.status === 401) {
                    accessToken = await refreshAccessToken(); // Try refreshing token
                    if (accessToken) {
                        return fetchUsers(); // Retry only once after getting new token
                    } else {
                        throw new Error("Session expired - please login again");
                    }
                }

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const data = await response.json();
                console.log("API Response:", data);

                const users = data.users || data.results || data;
                if (!Array.isArray(users)) {
                    throw new Error(`Expected array but got ${typeof users}`);
                }

                const tableBody = document.getElementById("userTableBody");
                tableBody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.first_name || 'N/A'}</td>
                        <td>${user.last_name || 'N/A'}</td>
                        <td>${user.spending_limit || 'N/A'}</td>
                        <td>${user.role?.name || user.role || 'N/A'}</td>
                        <td>${user.created_at || 'N/A'}</td>
                        <td>${user.updated_at || 'N/A'}</td>
                        <td>
                            <a href="/users/${user.id}/">View</a>
                            <a href="/users/${user.id}/edit/">Edit</a>
                            <a href="/users/${user.id}/delete/" onclick="return confirm('Are you sure?')">Delete</a>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error("Error fetching users:", error);
                alert(`Failed to load users: ${error.message}`);
                if (error.message.includes("expired") || !localStorage.getItem("accessToken")) {
                    window.location.href = "/login/";
                }
            }
        }

        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem("refreshToken");
            if (!refreshToken) {
                window.location.href = "/login/";
                return null;
            }

            try {
                const response = await fetch("http://127.0.0.1:8000/api/token/refresh/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ refresh: refreshToken })
                });

                if (!response.ok) throw new Error("Failed to refresh token");

                const data = await response.json();
                if (data.access) {
                    localStorage.setItem("accessToken", data.access);
                    return data.access;
                } else {
                    throw new Error("No access token received");
                }
            } catch (error) {
                console.error("Token refresh failed:", error);
                localStorage.removeItem("accessToken");
                localStorage.removeItem("refreshToken");
                window.location.href = "/login/";
                return null;
            }
        }

        fetchUsers();
    });
</script>
{% endblock %}