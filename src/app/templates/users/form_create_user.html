{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">CREATE NEW USER</h6>
    </div>
    <div class="card-body">
        <form id="createUserForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" class="form-control" id="firstName" name="firstName">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" class="form-control" id="lastName" name="lastName">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="limitBalance">Limit Balance</label>
                        <input type="number" class="form-control" id="limitBalance" name="limitBalance" step="0.01">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="role">Role*</label>
                        <select class="form-control" id="role" name="role" required>
                            <!-- Roles will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary">Create User</button>
                <a href="{% url 'users' %}" class="btn btn-secondary ml-2">Cancel</a>
            </div>
        </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        await loadRoles();
        setupCreateUserForm();
    });
    
    const apiBaseUrl = 'http://127.0.0.1:8000/api';
    const maxTokenRefreshAttempts = 1;
    
    // Utility Functions
    const showAlert = (message, type) => {
        document.querySelector('.alert')?.remove();
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `${message}<button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span></button>`;
        
        document.querySelector('.card-body')?.prepend(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    };
    
    const handleApiError = (error, context) => {
        console.error(`${context} error:`, error);
        return { success: false, error: error.message };
    };
    
    // Role Functions
    const populateRoleSelect = (roles, selectElement) => {
        selectElement.innerHTML = '';
        selectElement.add(new Option('-- Select Role --', '', true, false));
        selectElement.options[0].disabled = true;
        roles.forEach(role => selectElement.add(new Option(role.name, role.id)));
    };
    
    async function loadRoles() {
        const roleSelect = document.getElementById('role');
        try {
            const response = await fetch(`${apiBaseUrl}/roles/`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
            });
    
            if (response.status === 401 && await RefreshToken()) 
                return loadRoles();
            
            if (!response.ok) throw new Error('Failed to load roles');
            
            populateRoleSelect(await response.json(), roleSelect);
            roleSelect.required = true;
    
        } catch (error) {
            console.error('Error loading roles:', error);
            showAlert('Failed to load roles. Using default options.', 'warning');
            roleSelect.innerHTML = `
                <option value="" disabled selected>-- Select Role --</option>`;
        }
    }
    
    // User Functions
    async function createUser(userData, retryCount = 0) {
        try {
            const payload = {
                ...userData,
                role: userData.role_id,
                spending_limit: userData.spending_limit ? parseFloat(userData.spending_limit) : null
            };
    
            const response = await fetch(`${apiBaseUrl}/users/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                },
                body: JSON.stringify(payload)
            });
    
            if (response.status === 401 && retryCount < maxTokenRefreshAttempts && await RefreshToken()) 
                return createUser(userData, retryCount + 1);
            
            if (response.status === 400) {
                const errorData = await response.json();
                return { success: false, error: 'Validation failed', details: errorData, status: 400 };
            }
    
            if (!response.ok) throw new Error(`Request failed with status ${response.status}`);
            return { success: true, data: await response.json() };
    
        } catch (error) {
            return handleApiError(error, 'Create user');
        }
    }
    
    // Form Handling
    function setupCreateUserForm() {
        const createForm = document.getElementById('createUserForm');
        if (!createForm) return;
    
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('username').value.trim(),
                email: document.getElementById('email').value.trim(),
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirmPassword').value,
                limitBalance: document.getElementById('limitBalance').value,
                role_id: document.getElementById('role').value
            };
    
            // Validation
            if (!formData.username || !formData.email || !formData.password || !formData.confirmPassword || !formData.role_id) 
                return showAlert('Please fill in all required fields', 'danger');
            if (formData.password !== formData.confirmPassword) 
                return showAlert('Passwords do not match', 'danger');
    
            const submitBtn = createForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
    
            try {
                const result = await createUser({
                    ...formData,
                    spending_limit: formData.limitBalance
                });
                
                if (result.success) {
                    showAlert('User created successfully!', 'success');
                    createForm.reset();
                    document.getElementById('role').selectedIndex = 0;
                } else {
                    const errorMessage = result.details?.errors 
                        ? Object.entries(result.details.errors)
                            .map(([field, errors]) => `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`)
                            .join('<br>')
                        : result.details?.message || 'Failed to create user';
                    showAlert(errorMessage, 'danger');
                }
            } catch (error) {
                showAlert('An unexpected error occurred', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create User';
            }
        });
    }
    
    // Auth Functions
    async function RefreshToken() {
        try {
            const response = await fetch(`${apiBaseUrl}/auth/refresh/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh_token: localStorage.getItem('refreshToken') })
            });
    
            if (!response.ok) throw new Error('Token refresh failed');
            
            const data = await response.json();
            localStorage.setItem('accessToken', data.access_token);
            return data.access_token;
    
        } catch (error) {
            console.error('Token refresh error:', error);
            return null;
        }
    }
</script>
{% endblock %}