{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Page Heading -->
<!-- <h1 class="h3 mb-2 text-gray-800">List Role</h1> -->

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">LIST ROLE</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-dark">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Create Date</th>
                        <th>Update Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="roleTableBody">
                    <!-- Loop through the incomes and display them in the table -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", initUserTable);

    // Configuration
    const config = {
        apiBaseUrl: 'http://127.0.0.1:8000/api',
        maxTokenRefreshAttempts: 1
    };

    // Main initialization
    async function initUserTable() {
        try {
            const roles = await fetchRolesWithSilentRefresh();
            renderRoleTable(roles || []);
        } catch (error) {
            console.error("Initialization error:", error);
            renderRoleTable([]);
        }
    }

    // Fetch roles with token refresh fallback
    async function fetchRolesWithSilentRefresh(retryCount = 0) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
        };

        try {
            const response = await fetch(`${config.apiBaseUrl}/roles/`, { headers });

            if (response.status === 401 && retryCount < config.maxTokenRefreshAttempts) {
                const newToken = await silentlyRefreshToken();
                if (newToken) return fetchRolesWithSilentRefresh(retryCount + 1);
            }

            if (response.status === 401) {
                await handleSilentAuthFailure();
                return null;
            }

            if (!response.ok) throw new Error(`Request failed with status ${response.status}`);

            return await response.json();
        } catch (error) {
            console.error('Fetch error:', error);
            return null;
        }
    }

    // Render role table
    function renderRoleTable(roles) {
        const tableBody = document.querySelector("#dataTable tbody");
        if (!tableBody) return;

        tableBody.innerHTML = roles.map(role => `
            <tr>
                <td>${role.name || 'N/A'}</td>
                <td>${role.description || 'N/A'}</td>
                <td>${formatDate(role.created_at)}</td>
                <td>${formatDate(role.updated_at)}</td>
                <td>
                    ${createActionLink(`/roles/${role.id}/`, "View", "btn-info")}
                    ${createActionLink(`/roles/${role.id}/edit/`, "Edit", "btn-warning")}
                    ${createActionLink(`/roles/${role.id}/delete/`, "Delete", "btn-danger", true)}
                </td>
            </tr>
        `).join('');

        initializeDataTable();
    }

    // Helper functions
    const formatDate = dateString => dateString ? new Date(dateString).toLocaleString() : 'N/A';

    function createActionLink(href, text, className, isDelete = false) {
        const link = document.createElement("a");
        link.href = href;
        link.textContent = text;
        link.className = `btn btn-sm ${className} mx-1`;
        if (isDelete) link.onclick = e => !confirm("Are you sure?") && e.preventDefault();
        return link.outerHTML;
    }

    async function silentlyRefreshToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) return null;

        try {
            const response = await fetch(`${config.apiBaseUrl}/token/refresh/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh: refreshToken })
            });

            if (!response.ok) return null;

            const { access } = await response.json();
            if (access) localStorage.setItem('accessToken', access);
            return access;
        } catch (error) {
            console.error('Silent refresh failed:', error);
            return null;
        }
    }

    function handleSilentAuthFailure() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.setItem('sessionExpired', 'true');
    }

    function initSessionWatcher() {
        setInterval(() => {
            if (localStorage.getItem('sessionExpired') === 'true' && 
                !window.location.pathname.includes('/login')) {
                localStorage.removeItem('sessionExpired');
                window.location.href = '/login?silent_expire=true';
            }
        }, 5000);
    }
</script>
{% endblock %}