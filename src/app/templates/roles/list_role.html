{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Page Heading -->
<!-- <h1 class="h3 mb-2 text-gray-800">List Role</h1> -->

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">LIST ROLE</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-dark">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Create Date</th>
                        <th>Update Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="roleTableBody">
                    <!-- Loop through the incomes and display them in the table -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        async function fetchUsers(retry = true) {
            let accessToken = localStorage.getItem("accessToken");
            if (!accessToken) {
                console.error("No access token found.");
                return;
            }
    
            try {
                let response = await fetch("http://127.0.0.1:8000/api/roles/", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    }
                });
    
                if (response.status === 401) {
                    accessToken = await refreshAccessToken(); // Try refreshing token
                    if (accessToken) {
                        return fetchUsers(); // Retry only once after getting new token
                    } else {
                        throw new Error("Session expired - please login again");
                    }
                }
    
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
    
                const data = await response.json();
                console.log("API Response:", data);
    
                const roles = data.roles || data.results || data;
                if (!Array.isArray(roles)) {
                    throw new Error(`Expected array but got ${typeof roles}`);
                }
    
                const tableBody = document.getElementById("roleTableBody");
                tableBody.innerHTML = roles.map(role => `
                    <tr>
                        <td>${role.name || 'N/A'}</td>
                        <td>${role.description || 'N/A'}</td>
                        <td>${role.created_at || 'N/A'}</td>
                        <td>${role.updated_at || 'N/A'}</td>
                        <td>
                            <a href="/roles/${role.id}/">View</a>
                            <a href="/roles/${role.id}/edit/">Edit</a>
                            <a href="/roles/${role.id}/delete/" onclick="return confirm('Are you sure?')">Delete</a>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error("Error fetching roles:", error);
                alert(`Failed to load roles: ${error.message}`);
            }
        }
    
        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem("refreshToken");
            if (!refreshToken) {
                console.error("No refresh token available.");
                return null;
            }
    
            try {
                const response = await fetch("http://127.0.0.1:8000/api/token/refresh/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ refresh: refreshToken })
                });
    
                if (!response.ok) {
                    throw new Error("Failed to refresh token");
                }
    
                const data = await response.json();
                if (data.access) {
                    localStorage.setItem("accessToken", data.access);
                    console.log("Token refreshed successfully.");
                    return data.access;
                } else {
                    throw new Error("No access token received");
                }
            } catch (error) {
                console.error("Token refresh failed:", error);
                return null;
            }
        }
    
        fetchUsers();
    });
</script>
{% endblock %}