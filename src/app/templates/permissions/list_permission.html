{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Page Heading -->
<!-- <h1 class="h3 mb-2 text-gray-800">List Permission</h1> -->

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">LIST PERMISSION</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-dark">
                    <tr>
                        <th>Name</th>
                        <th>Codename</th>
                        <th>Description</th>
                        <th>Create Date</th>
                        <th>Update Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="permissionTableBody">
                    <!-- Loop through the incomes and display them in the table -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    // Check if valid user data was received...
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const permissions = await fetchPermissionsWithSilentRefresh();
            if (permissions && permissions.length > 0) {
                renderPermissionTable(permissions);
            } else {
                console.warn("No users found or failed to fetch.");
                renderPermissionTable([]); // Render an empty table
            }
        } catch (error) {
            console.error("Initialization error:", error);
            renderPermissionTable([]); // Render an empty table
        }
    });

    // Configuration
    const apiBaseUrl = 'http://127.0.0.1:8000/api';
    const maxTokenRefreshAttempts = 1;

    // Main function to fetch permissions with silent refresh
    async function fetchPermissionsWithSilentRefresh(retryCount = 0) {
        let accessToken = localStorage.getItem('accessToken');
        
        try {
            const response = await fetch(`${apiBaseUrl}/permissions/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            // If unauthorized and we haven't maxed out retries
            if (response.status === 401 && retryCount < maxTokenRefreshAttempts) {
                const newToken = await silentlyRefreshToken();
                if (newToken) {
                    return fetchPermissionsWithSilentRefresh(retryCount + 1);
                }
            }

            // If still unauthorized after refresh attempts
            if (response.status === 401) {
                await handleSilentAuthFailure();
                return null;
            }

            if (!response.ok) {
                throw new Error(`Request failed with status ${response.status}`);
            }

            return await response.json();

        } catch (error) {
            console.error('Fetch error:', error);
            return null;
        }
    }

    function renderPermissionTable(permissions) {
        const tableBody = document.querySelector("#dataTable tbody");
        if (!tableBody) return;
        tableBody.innerHTML = '';
        permissions.forEach(permission => {
            const row = document.createElement("tr");
            const addCell = (value) => {
                const td = document.createElement("td");
                td.textContent = value || 'N/A';
                return td;
            };
            row.appendChild(addCell(permission.name));
            row.appendChild(addCell(permission.codename));
            row.appendChild(addCell(permission.description));
            row.appendChild(addCell(formatDate(permission.created_at)));
            row.appendChild(addCell(formatDate(permission.updated_at)));

            const actionCell = document.createElement("td");
            actionCell.appendChild(createActionLink(`/permissions/${permission.id}/`, "View", "btn-info"));
            actionCell.appendChild(createActionLink(`/permissions/${permission.id}/edit/`, "Edit", "btn-warning"));
            actionCell.appendChild(createActionLink(`/permissions/${permission.id}/delete/`, "Delete", "btn-danger", true));
            
            row.appendChild(actionCell);
            tableBody.appendChild(row);
        });

        // Initialize DataTable (if using jQuery DataTables)
        initializeDataTable();
    }

    // ================== Helper Functions ==================
    function createActionLink(href, text, className, isDelete = false) {
        const link = document.createElement("a");
        link.href = href;
        link.textContent = text;
        link.className = `btn btn-sm ${className} mx-1`;

        if (isDelete) {
            link.onclick = (e) => {
                if (!confirm("Are you sure you want to delete this user?")) {
                    e.preventDefault();
                }
            };
        }
        return link;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    }

    // Silent token refresh (no UI alerts)
    async function silentlyRefreshToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) return null;

        try {
            const response = await fetch(`${apiBaseUrl}/token/refresh/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refresh: refreshToken })
            });

            if (!response.ok) return null;

            const { access } = await response.json();
            if (!access) return null;

            // Store the new token silently
            localStorage.setItem('accessToken', access);
            return access;

        } catch (error) {
            console.error('Silent refresh failed:', error);
            return null;
        }
    }

    // Handle auth failure without alerting user
    async function handleSilentAuthFailure() {
        // Clear invalid tokens
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.setItem('sessionExpired', 'true');
    }

    // Initialize a session watcher
    function initSessionWatcher() {
        setInterval(() => {
            if (localStorage.getItem('sessionExpired') === 'true') {
                if (!window.location.pathname.includes('/login')) {
                    localStorage.removeItem('sessionExpired');
                    window.location.href = '/login?silent_expire=true';
                }
            }
        }, 5000);
    }
</script>
{% endblock %}